---
layout: post
title: Cleaning your vCloud Director Thumbnails (current.png)
tags:
- PowerCLI
- vCloud
- vmware
status: publish
type: post
published: true
meta:
  _wpas_done_twitter: '1'
---
Thumbnail images. You know 'em, you love 'em. vCloud Director uses thumbnails to give you a preview of the screen without opening up the remote console. Kinda handy, except that well...they are just a black box most of the time anyway. vCloud Director stores these thumbnail images as current.png on the datastore in the VM's folder.

An interesting side effect of this feature comes whenever you migrate/<a title="Virtu-Al PowerCLI sVmotion" href="http://www.virtu-al.net/2011/09/14/quick-and-simple-storage-vmotion-scripts/" target="_blank">svMotion</a> a machine managed by vCloud Director. It leaves the folder along with the thumbnail (<strong><span style="color:#ff0000;">current.png</span></strong>). So, if you are shuffling VMs around on your datastores, stuff can get sloppy looking pretty quick. Why is this? ESX doesn't know (or care) about the thumbnail image.

The following PowerCLI script will go through a particular datastore, looking for orphaned current.png files. It will then delete the file and the VM folder, successfully keeping your datastores nice and neat!

NOTE: Thanks Dean for testing and the bug fix!

{% highlight powershell %}
$datastore = "MyDatastore"
$viserver = "MyVIServer"

# add PowerCLI snapin
Add-PSSnapin vmware.vimautomation.core -ErrorAction:SilentlyContinue

# Connect to VI Server
Connect-VIServer $viserver

# Get the datastore we want to clean up
$dsObject = Get-Datastore $datastore

# Create a new PSDrive to that datastore
New-PSDrive -Location $dsObject -name ds -PSProvider VimDatastore -root '\'

# Set location to that drive
Set-Location ds:

# From here we are going to parse through
# folders first looking for vmx files,
# if there are no vmx files,
# test for current.png and then remove the thumbnail and folder.

$dsfolders = Get-ChildItem

foreach ($dsfolder in $dsfolders)
{
    if (!(test-path "$dsfolder\*.vmx"))
    {
        if (test-path "$dsfolder\current.png")
        {
            remove-item "$dsfolder\current.png"
            if ((get-childitem .\$dsfolder\* | measure-object).count -lt 1)
            {
                remove-item $dsfolder
            }
        }
    }
}
{% endhighlight %}
